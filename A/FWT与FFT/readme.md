<center><font size=7> FWT ? FFT !</font></center>

写作缘由：[jzoj七星连珠](https://gmoj.net/senior/#contest/show/3408/2)

### FFT

进一步研究FFT： 做了一件什么事情？

构造了一个矩阵$b_{i,j} = w_n ^ {i * j}$, 使得将a Dft成A后，$A_i = \sum b_{i,j} * a_j$

而且这个过程是通过单位根的性质（主要是对称性）进行分治得到结果的。因此可以很好地解释蝴蝶变换，但这跟今天的主题无关。

### FWT

本文的FWT说的是异或卷积，不是or和and卷积。

FWT构造了一个这样的矩阵：$b_{i,j} = (popcount(i\&j)\& 1 ) ? -1 : 1$, 由于$（pop(i\& j)\&1 ） xor （pop(i\&k)\&1） = pop(i \& (j \space xor\space k))\&1$ ,因此当我们把$b_{i,j}$和$b_{i,k}$ 乘起来，因为都是-1 or 1,(-1 * -1 == 1 == 1*1, 对应着 1 xor 1 == 0 == 0 xor 0),因此就可以当成异或运算，

### FFT和FWT的共同点

注意到，他们都构造了一种可逆的矩阵，并通过分治的方法快速求和。同样的在iDft之后，他们都要除以长度（而FWT的一般写法是每层除以2，跟一次性直接除以长度没啥区别）。

研究一下这个矩阵$b_{i,j}$ : 注意到FFT的$b_{i,j}$ 乘上$b_{i,k}$的时候，对应的权值从$w_n^{ij}$和$w_n^{ik}$变成了$w_n^{i*(j+k)}$,正好是$b_{i,j+k}$的权值； 而FWT中$b_{i,j} * b_{i,k}$,正好对应着$b_{i,j\space xor\ k}$,而且这些映射都是根据这个权值长什么样推出正确性的。

### 单位根

进一步发现：实际上FWT中我们要做的事情不是把次数变成a + b,而是变成a xor b ,等价于对一共log个二进制位，都对应做不进位（模2意义下）的加法。

这等价于对每一位的次数，做个**长度为2的循环卷积** 。因此，我们可以把上边的 =="正一"看做$w_2^0$, "负一"看做$w_2^1$== ! 对于每一位考虑，如果当前两个元素，这一位分别是u和v，在i这个位置做累加，那么他们乘起来正是$w_n^{(u+v)\%2*i}$ !

**它会不会贡献到别的项上呢？**

不会：考虑i这个位置Dft一下贡献到了j，立刻iDft回去，j iDft又贡献到了k，那么系数是$\sum_j w_2^{ij} * w_2^{-jk} = \sum_j w_2^{j*(i-k)}$, 当i-k!=0的时候这个式子显然为0.而对于log个位考虑，只有全部位贡献都正确的时候才不为0.

更进一步：倘若我们要搞**三进制异或卷积**怎么办：把二进制Dft改一改，变成长度跨度为3的次幂那种，接下来把单位根换成$w_3^0, w_3^1,w_3^2$, 那么$b_{i,j}$就对应着每个位的$w_3^{u*v}$ ,那么这样也是正确的。这就是开头那道题的核心解法。当然也可以用模意义下原根代替单位根。

因此，FFT和FWT本质相同，只不过FWT将n变成了2，使得超出2之后循环了！而FFT让n > lenA+lenB,使得它没法循环而已。

更进一步，如果我们就是要直接做长度为T的循环卷积（例如[jzoj7072决战圣诞树](https://gmoj.net/senior/#main/show/7072)），就可以带T个$w_T^i$（或者模意义下原根$g^{(mo-1)/T}$)进去求点值,卷积的时候直接O(T)卷。然鹅这里T可能不是2的若干次幂，这个时候就只能暴力了。



### 总结

因此，在单位圆上，单位根的对称性十分重要，它的周期性也可以成为解题的关键！

