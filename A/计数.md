# 计数(FK著)

## 前言

- 本篇难度较低，适宜初学者进行学习。
- 知识点较多较散，难度还没有完全排好，只能保证一个大知识点里面的难度由易到难。
- 如有错误的地方欢迎指正。











## 组合数

- 没什么好说的，这是计数最基础的部分了。



### 定义

- 从$n$个物品中选出$m$个并考虑取出的先后顺序的方案数为$A_n^m$。
- 从$n$个物品中选出$m$个不考虑先后顺序的方案数为$C_n^m$，同时也可以表示为$\binom{n}{m}$。
- 其中$C_n^m$在计数题中出现更为频繁，所以接下来将基本围绕$C_n^m$展开。




### 如何求？

#### 递推式

- $$
  \binom{n}{m}=\binom{n-1}{m-1}+\binom{n-1}{m}
  $$

- 靠这个计算是$O(n*m)$的。

#### 公式

- $$
  \binom{n}{m}=\frac{n!}{m!*(n-m)!}
  $$

- 用这个计算是$O(m)$的。



### 一些基本性质

$$
1.\binom{n}{m}=\binom{n}{n-m}\\
2.\sum_{i=0}^n\binom{n}{i}=2^n\\
3.\sum_{i=0}^n(-1)^i*\binom{n}{i}=0
$$



### 一些很重要的技巧

#### 简单的元素排列

- 有$m$类元素，其中第$i$类元素有$a_i$个，问有多少种排列方案？
- 通过组合数可以简单得到方案数为$\binom{a_1}{a_1}*\binom{a_1+a_2}{a_2}*\binom{a_1+a_2+a_3}{a_3}*...=\frac{(a_1+a_2+a_3+...+a_n)!}{a_1!*a_2!*a_3!*...*a_n!}$。

#### 如何求一列组合数的和

- $$
  \sum_{i=m}^n\binom{i}{m}=\binom{n+1}{m+1}
  $$

- 

#### 二项式定理

- $$
  (a+b)^n=\sum_{i=0}^na^i*b^{n-i}*\binom{n}{i}
  $$

#### 卢卡斯定理

- $$
  \binom{n}{m} \equiv \binom{n\%p}{m\%p}*\binom{n/p}{m/p} (\mod p)
  $$

- 注意：$p$为质数。

- 经典问题：$\binom{n}{m}$要为奇数需要满足什么条件？

- 套用卢卡斯定理，考虑$p=2$的情况，

- 我们发现卢卡斯定理模拟的是把$n,m$转化为二进制的过程。

- 考虑$n=a_1a_2a_3...a_p,m=b_1b_2b_3...b_q$。

- 那么如果$\binom{n}{m}$为偶数当且仅当存在一个$i$使得$\binom{a_i}{b_i}=0$。

- 因为是转化为二进制，所以$0<=a_i,b_i<=1$。

- 所以当$\binom{a_i}{b_i}=0$时，$a_i=0,b_i=1$。

- 也就是说，假如$\binom{n}{m}$为奇数，先将$n,m$转化为二进制数，如果$m$的某一位为1，则$n$的对应为必为1，即$n\and m=m$​。

#### 扩展卢卡斯定理

- 就是当$p$不为质数是应该如何处理？
- 按照老套路，我们直接将$p$分解质因数$p=a_1^{b_1}*a_2^{b_2}*a_3^{b_3}*...*a_k^{b_k}$。
- 我们只需要对于每一个质因数求出$\binom{n}{m}\mod a_i^{b_i}$​，然后用中国剩余定理合并即可。​
- 由于$m!$和$(n-m)!$有可能没有逆元，所以我们先把阶乘内所有$a_i$的质因子提取出来。然后把所有$[1,n],[1,m],[1,n-m]$中与$a_i$互质的数乘起来即可——当然不是直接暴力乘，发现可以以$a_i^{b_i}$为循环节分组，每一个循环节内的乘积都是一样的，快速幂即可。
- ~~之所以讲得如此简略，显然是因为这其实像是数论的内容。~~

#### 消去乘积

- $\sum_{i=0}^n \binom{a}{i}*\binom{b}{n-i}=\binom{a+b}{n}$​
- $\sum_{i=0}^n\binom{i}{a}*\binom{n-i}{b}=\binom{n+1}{a+b+1}$

#### 挡板问题

- 有$n$个有序正整数加起来等于$m$，求方案数？
- 该问题的答案为$\binom{m-1}{n-1}$​​。
- 如果每一个数有限定最小值$d$，那么方案数为$\binom{m-(d-1)*n-1}{n-1}$。



### 定义域的扩展

- 对于组合数$\binom{n}{m}$，我们可以扩展到$n$为实数的情况：

- $$
  \binom{n}{m}=\frac{\Pi_{i=0}^{m-1}(n-i)}{m!}(n\in \R,m\in \N)
  $$

- 该组合数仍然满足二项式定理，意即：

- $$
  (a+b)^n=\sum_{i=0}^\infty a^i*b^{n-i}*\binom{n}{i}(n\in \R)
  $$

- 这个时候大家或许会有疑惑，左式$a,b$是对称的，但右式$a,b$并不是对称的，这是为什么呢？

- 这是因为——想让这个式子有值，就必须让右式是收敛的而非发散的。

- 例如$(2+1)^{1.5}$，倘若我们代入$a=2,b=1$，跑一下程序你就会发现右边的式子只会在很大的正数和很大的负数之间左右横跳，只有当$a=1,b=2$时，才可以趋近于$3^{1.5}$。

- 一般情况下，我们发现每增加1，右式不考虑组合数的话就会乘上$\frac{a}{b}$，所以只要让$\frac{a}{b}<1$就行了。

- 那么这东西有什么用呢？

- 其实要是在数学领域，这东西绝对会有超级多奇奇怪怪的用处，这里就介绍一个和生成函数相关的。

- 比如对于$\sqrt{x+1}$​，我们当然可以~~多项式开方~~，但是我们也可以先用二项式定理展开一下：

- $$
  \sqrt{1+x}=(1+x)^{\frac{1}{2}}=\sum_{i=0}^\infty x^i*\binom{\frac{1}{2}}{i}
  $$

  

- 这样子就可快速求出某一项的系数了。



### 生成函数形式

- 由于组合数有两个变量，所以其生成函数一般为二元生成函数：

- 我们需要定义一个生成函数$F$使得$[x^iy^j]F(x,y)=\binom{i}{j}$。

- 发现可以直接展开：

- $$
  \begin{align}
  F(x,y)=&\sum_{i=0}\sum_{j=0}\binom{i}{j}x^iy^j\\
  =&\sum_{i=0}x^i*(y+1)^i\\
  =&\frac{1}{1-x*(y+1)}
  \end{align}
  $$

- 那么这个有什么用呢？我们来看下面这个式子：

- $\sum_{i=0}^n\binom{n+i}{2*i}$

- 看起来似乎没有什么直接的方法算出这个式子的值。

- 但是我们发现这个组合数有特定的线性关系，这个式子中的每一个组合数$\binom{a}{b}$，都满足$2*a-b=2*n$。

- 考虑如何用生成函数表示这种关系，一种直观的方法是将二元生成函数变为一元生成函数，即将$y=x^{-\frac{1}{2}}$代入，那么$x^iy^j=x^i(x^{-\frac{1}{2}})^j=x^{i-\frac{j}{2}}$，只要满足$i-\frac{j}{2}=n$即可，所以只需要求出这个生成函数$x^n$的系数。

- 代入后得到的生成函数为：

- $$
  \frac{1}{1-x*(x^{-\frac{1}{2}}+1)}=\frac{1}{1-\sqrt{x}-x}
  $$

- 发现它和斐波那契数列的生成函数神似，实际上可以得出$\sum_{i=0}^n\binom{n+i}{2*i}=F_{2n+1}$，其中$F$表示斐波那契数列。

- 实际上如果从组合意义角度去考虑斐波那契，设$G_n$​​表示有一排$n$​​个格子，往里面放球，需要每个球之间要么相邻，要么只有一个空格子，现在已经确定$n$​​号会放球，求剩下格子放球的方案数，发现其满足递推式$G_i=G_{i-1}+G_{i-2}$​​​，但需要平移$G_i=F_{i+1}$​​​​。

- 与此同时，如果我们用组合数来求解方案数，由于空格子之间不能相邻，所以可以考虑枚举空格子的个数$k$​​​，运用挡板问题可以发现方案数为$\binom{n-k}{k}$​​，那么总方案数为$G_n=\sum_{i=0}^n\binom{n-i}{i}$​。

- 所以$F_{2*n+1}=G_{2*n}=\sum_{i=0}^{2*n}\binom{2*n-i}{i}=\sum_{i=0}^{2*n}\binom{n+(n-i)}{2*(n-i)}=\sum_{i=0}^{n}\binom{n+i}{2*i}$。

- 倘若正推的话，显然组合意义的思维难度比生成函数高，所以遇到复杂的组合问题常常可以用生成函数求解。











## 卡特兰数

- 这个东西比较简单。
- 例题：括号配对问题。
- 一个串是否合法，满足以下条件：
- 1.空串为合法
- 2.如果一个串A是合法的，那么(A)是合法的
- 3.如果串A和串B都是合法的，那么AB是合法的
- 例如(())()是合法的，但是())(是不合法的。
- 问：有多少长度为$n$的串A是合法的？



### 例题解法

#### 暴力1

- 设$f[i][j]$表示做到第$i$位，还剩下$j$个左括号没有匹配的方案数。
- 可以得到$f[i][j]=f[i-1][j-1]+f[i-1][j+1]$。
- 注意一下边界情况即可。
- 时间复杂度$O(n^2)$。



#### 暴力2

- 设$f[i]$​表示长度为$i*2$​的合法串有多少个。
- 显然这个串的最后一个字符肯定为右括号，枚举这个右括号和哪一位的左括号匹配。
- 可以得到转移式：$f[i]=\sum_{j=0}^{i-1}f[j]*f[i-1-j]$​。
- 直接做时间复杂度是$O(n^2)$的。
- 但是发现这个式子具有卷积的形式，分治FFT可以做到$O(n*log^2n)$的。



#### 正解

- 正难则反，考虑合法方案数=总方案数-不合法方案数。
- 总方案数为$\binom{n}{\frac{n}{2}}$的，就是在$n$个位置中随便选择$\frac{n}{2}$个位置填左括号，剩下的位置填右括号。
- 不合法的方案就是存在某些位置前面右括号的数量比左括号多。
- 从左往右找到第一个这种位置，发现右括号恰好比左括号多一个（否则这个位置一定不是第一个）。
- 这个时候我们把这个位置后面的所有字符取反，即左括号变右括号，右括号变左括号。
- 例如((())))(会变成((()))))。
- 发现取反以后的序列一定会有$\frac{n}{2}-1$个左括号，$\frac{n}{2}+1$个右括号。
- 又可以发现所有含有$\frac{n}{2}-1$个左括号，$\frac{n}{2}+1$个右括号的序列通过逆操作一定可以变回含有$\frac{n}{2}$个左括号和右括号的**不合法序列**。并且是一一映射的关系，也就是不会有多个序列经过逆操作之后变回同一个序列。
- 也就是说不合法序列的个数等于含有$\frac{n}{2}-1$个左括号，$\frac{n}{2}+1$个右括号的序列总个数，也就是$\binom{n}{\frac{n}{2}-1}$。
- 所以合法方案数等于$\binom{n}{\frac{n}{2}}-\binom{n}{\frac{n}{2}-1}$。
- 看起来有点丑，设$2*m=n$，那么方案数等于$\binom{2m}{m}-\binom{2m}{m-1}$，也就是$\frac{\binom{2m}{m}}{m+1}$。
- 时间复杂度$O(n)$​。



### 卡特兰数在哪里？

- 卡特兰数就是$\frac{\binom{2m}{m}}{m+1}$​。



### 生成函数形式

- 考虑从“暴力2”的递推式入手。

- 设$C(x)=\sum_{i=0}f[i]*x^i$​​，$f[i]$​​的含义见“暴力2”。

- 由递推式可以简单得到：$C(x)=C(x)*C(x)*x+1$，注意由于$*x$后常数项为0，所以要在后面$+1$。

- 把$C(x)$​当作未知数来解这一个一元二次方程：

- $$
  \begin{align}
  C^2(x)*x+1&=C(x)\\
  C^2(x)*x-C(x)+1&=0\\
  C(x)&=\frac{1\pm \sqrt{1-4x}}{2x}
  \end{align}
  $$

- 但现在有两个解，显然有一个解是不对的。

- 有一个比较神奇的判定方法，我们计算$\lim_{x\to0}C(x)$的值，发现$\frac{1+ \sqrt{1-4x}}{2x}$的值显然是不收敛的，而$\frac{1- \sqrt{1-4x}}{2x}$最终会向1无限趋近，而这正好和$f[0]$的值相等（显然当$x=0$时$C(x)=f[0]=1$），所以$C(x)=\frac{1- \sqrt{1-4x}}{2x}$。

- 考虑进一步推进，采用扩展二项式定理，$\sqrt{1-4x}=(1-4x)^{\frac{1}{2}}=\sum_{i=0}^\infty (-4x)^i*\binom{\frac{1}{2}}{i}$。

- 因此$f[i]=[x^i]C(x)=[x^{i+1}]\frac{-\sqrt{1-4x}}{2}=\frac{(-4)^{i+1}*\binom{\frac{1}{2}}{i+1}}{2}$​​​​​​，拆开得到：

- $$
  \begin{align}
  f[i-1]&=\frac{(-4)^i*\frac{\prod_{j=0}^{i-1}(\frac{1}{2}-j)}{i!}}{2}\\
  &=\frac{4^i*\frac{\prod_{j=0}^{i-1}(j-\frac{1}{2})}{i!}}{2}\\
  &=\frac{4^i*\frac{\prod_{j=0}^{i-1}(j-\frac{1}{2})}{i!}}{2}\\
  &=\frac{2^i*\frac{\prod_{j=1}^{i-1}(2*j-1)}{i!}}{2}\\
  &=\frac{2^i*\frac{\prod_{j=1}^{i-1}(2*j-1)*(i-1)!}{i!*(i-1)!}}{2}\\
  &=\frac{2*\frac{(2*i-2)!}{i!*(i-1)!}}{2}\\
  &=\frac{\binom{2*(i-1)}{i-1}}{i}\\
  \end{align}
  $$

- 从这个方法我们也可以推出卡特兰数的通项公式$\frac{\binom{2*n}{n}}{n+1}$。











## 斯特林数

### 基本定义

#### 第一类斯特林数

- 第一类斯特林数：$s(n,m)$表示把$n$个元素分成$m$个圆排列的方案数。
- 其中圆排列指的是首尾相接的排列，可以通过旋转互相得到的两个排列是等价的，算作一种。
- 递推公式：$s(n,m)=s(n-1,m-1)+(n-1)*s(n-1,m)$

#### 第二类斯特林数

- 第二类斯特林数：$S(n,m)$表示把$n$个有区别的元素分成$m$个无差别的集合的方案数。
- 递推公式：$S(n,m)=S(n-1,m-1)+S(n-1,m)*m$。
- 通项公式：$S(n,m)=\sum_{i=0}^m\frac{(-1)^{m-i}*i^n}{i!*(m-i)!}$。
- 证明：考虑容斥，先假设集合之间是有序的，如果集合可以为空那么方案数就为$m^n$，第二类斯特林数要求集合非空，所以我们可以枚举空集合的个数$i$，从$m$个集合中选择$i$个的方案数是$\binom{m}{i}=\frac{m!}{i!*(m-i)!}$的。最后由于要把有序变为无序，所以要除以$m!$。



### 快速求法

- 这里指的是如何快速求出**同一行**的斯特林数。

#### 通项公式法

- 发现第二类斯特林数有通项公式。
- 仔细观察即可以发现这个公式可以卷出来，$O(nlogn)$FFT即可。

#### 生成函数法

- 第一类斯特林数：
- 设$F_n(x)=\sum_iS(n,i)*x^i$。
- 由递推式可以得出$F_n(x)=(n-1)*F_{n-1}(x)+x*F_{n-1}(x)=(x+n-1)F_{n-1}(x)$。
- 所以$F_n(x)=\sum_{i=0}^{n-1}(x+i)$。是一个很经典的上升幂。
- 假如分治FFT的话是$O(n*log^2n)$的，稍微优化可以做到$O(n*logn)$的。
- 第二类斯特林数：
- 考虑用指数型生成函数。
- 一个集合的生成函数为$G(x)=\sum_{i=1}\frac{x^i}{i!}$。
- 那么$m$个集合的生成函数就是$G^m(x)$。
- 多项式快速幂的话考虑多项式exp/ln。
- 但由于这个方法常数极大，比上文的通项公式法劣很多，所以一般不用。



### 上升幂/下降幂

- 上升幂：$x^{\bar{n}}=\prod_{i=0}^{n-1}(x+i)$。
- 下降幂：$x^{\underline{n}}=\prod_{i=0}^{n-1}(x-i)$。
- 根据上文我们可以知道$x^{\bar{n}}=\sum_{i=0}^ns(n,i)*x^i$。
- 同时也可以推出$x^{\underline{n}}=\sum_{i=0}^ns(n,i)*(-1)^{n-i}*x^i$。
- 那么上升/下降幂和第二类斯特林数有什么关系呢？
- 考虑下降幂的组合意义：$x^{\underline{n}}=\binom{x}{n}*n!$。
- $x^n$的组合意义：有$x$种颜色，$n$个球，给每一个球涂一种颜色的方案数。
- 从另一个角度考虑这个问题：你先从$x$个颜色中选好必用的$i$种颜色，然后把$n$个球分成$i$个集合，每个集合里面的球涂一种颜色。
- 发现方案数是$\binom{x}{i}*S(n,i)*i!$，其中乘$i!$是因为第二类斯特林数里面的集合是没有标号的，分配标号本身有$i!$种方案。
- 以上可以得出等式$x^n=\sum_i\binom{x}{i}*S(n,i)*i!=\sum_iS(n,i)*x^{\underline{i}}$

- 同时便也可以得出$x^n=\sum_i(-1)^{n-i}*S(n,i)*x^{\bar{i}}$。



### 斯特林数反演

#### 反转公式

- 我们发现上升下降幂建立起了两类斯特林数之间的桥梁。

- $$
  x^n=\sum_i(-1)^{n-i}*S(n,i)*x^{\bar{i}}\\
  =>x^n=\sum_i(-1)^{n-i}*S(n,i)*\sum_{j=0}^is(i,j)*x^j\\
  =>x^n=\sum_{j=0}^nx^j*\sum_{i=j}^nS(n,i)*s(i,j)*(-1)^{n-i}
  $$

- 发现等号左边为只有一个项的多项式，因此等号右边$x^n$的系数应为1，其它次数的项的系数应为0。

- 所以当且仅当$j=n$时$\sum_{i=j}^nS(n,i)*s(i,j)*(-1)^{n-i}=1$，其余情况等于0。

- 类似的，我们可以得到$\sum_{i=j}^ns(n,i)*S(i,j)*(-1)^{n-i}=[j==n]$。

- 以上两个式子我们称为”反转公式“，也可以考虑用斯特林数的递推式来证明它。

#### 反演公式

- 反转公式对于斯特林数反演究竟有什么作用呢？
- 很重要的一点就是它把两类斯特林数联系在了一起。
- 比如一个SB式子$f(n)=\sum_{i=0}^nf(i)*[i==n]$。（不要小瞧它，它是推式子的一个重要套路）
- 我们可以根据反转公式得到$f(n)=\sum_{i=0}^nf(i)*\sum_{j=i}^ns(n,j)*S(j,i)*(-1)^{n-j}$。
- 这不是变复杂了吗？
- 别急，我们移项，$f(n)=\sum_{j=0}^ns(n,j)*(-1)^{n-j}*\sum_{i=0}^jf(i)*S(j,i)$。
- 并假设$g(n)=\sum_{i=0}^nf(i)*S(n,i)$，我们可以得到$f(n)=\sum_{j=0}^ns(n,j)*(-1)^{n-j}*g(j)$。
- 一个反演公式就这样诞生了！~~（好不自然）~~
- 反过来我们也可以得到另一个反演公式：
- 如果$g(n)=\sum_{i=0}^nf(i)*s(n,i)$，那么$f(n)=\sum_{j=0}^nS(n,j)*(-1)^{n-j}*g(j)$​。



### 生成函数形式

#### 第一类斯特林数

- 一行斯特林数的生成函数显然是$\prod_{i=0}^{n-1}(x+i)$。

- 对于一列的斯特林数，考虑利用第一类斯特林数和上升幂之间的关系：

- $$
  \begin{align}
  (1-x)^y&=\sum_{i=0}^yy^{\underline i}*(-1)^i*\frac{x^i}{i!}\\
  &=\sum_{i=0}^y\sum_{j=0}^is(i,j)*(-1)^{j}*y^j*\frac{x^i}{i!}\\
  &=\sum_{j=0}^yy^j*(-1)^{j}*\sum_{i=j}^ys(i,j)*\frac{x^i}{i!}\\
  \end{align}
  $$

- 与此同时，$(1-x)^y$还可以进行另一个方向上的转化：

- $$
  (1-x)^y=e^{ln(1-x)*y}=\sum_{j=0}^\infty\frac{[ln(1-x)]^j}{j!}*y^j
  $$

  

- 从而可以得到$\sum_{i=j}^\infty s(i,j)*\frac{x^i}{i!}=\frac{[-ln(1-x)]^j}{j!}$。

- 根据这个可以$O(n*logn)$​求出一整列斯特林数的值。

- 组合意义：

- $-ln(1-x)=ln(\frac{1}{1-x})=\sum_{i=0}^\infty \frac{x^i}{i}$​，表示一个圆排列的生成函数。

- 那么$[-ln(1-x)]^j$即为$j$​个圆排列组合起来，由于圆排列本身是没有标号的，所以最后要除以$j!$。



### 第二类斯特林数

- 这个可以直接上通项公式：

- $$
  \begin{align}
  S(n,m)&=\sum_{i=0}^m\frac{i^n*(-1)^{m-i}}{i!*(m-i)!}\\
  &=\frac{1}{m!}\sum_{i=0}^m i^n*(-1)^{m-i}*\binom{m}{i}\\
  &=[x^n]n!*\frac{1}{m!}\sum_{i=0}^me^{ix}*(-1)^{m-i}*\binom{m}{i}\\
  &=[x^n]n!*\frac{1}{m!}(e^x-1)^m
  \end{align}
  $$

- 所以$\sum_i\frac{S(i,m)}{i!}=\frac{(e^x-1)^m}{m!}$。

- 根据这个可以求出一整列斯特林数的值。

- 组合意义：

- 考虑$e^x$​表示一个集合的生成函数，那么$(e^x)^m$就是把$m$个集合组合起来，$(e^x-1)^m$是加上了“集合非空”这一限制，而由于集合是没有标号的，所以最后除以$m!$​。

- 但是如果真的只需要求一列第二类斯特林数的话不用这样子，发现它的递推式和第一类斯特林数是行列对称的，考虑能否通过某些转化得到类似于第一类斯特林数的$\prod_{i=0}^{n-1}(x+i)$的式子。

- 直接考虑OGF$F_m(x)=\sum_{i=0}S(i,m)*x^i$，由递推式$S(n,m)=S(n-1,m-1)+S(n-1,m)*m$可以得到：

- $$
  \begin{align}
  F_m(x)&=x*F_{m-1}(x)+mx*F_{m}(x)\\
  (1-mx)F_m(x)&=x*F_{m-1}(x)\\
  F_m(x)&=\frac{x}{1-mx}*F_{m-1}(x)
  \end{align}
  $$

- 那我们就可以得到：

- $$
  F_m(x)=x^m*(\prod_{i=1}^m1-ix)^{-1}
  $$

- 发现$\prod_{i=1}^m1-ix$的形式与$\prod_i(x+i)$类似，也可以用$O(n*logn)$求。



### 小例题

- 例题：cf932E Team Work

- 题目大意：

- $$
  \sum_{i=1}^n\binom{n}{i}*i^k
  $$

- $n<=10^9,k<=5000$

- solution：

- 看$k$次方很不爽，想要变成下降幂，这样子就可以和组合数合并了！

- $$
  \begin{align}
  \sum_{i=1}^n\binom{n}{i}*i^k 
  &=\sum_{i=1}^n\binom{n}{i}*\sum_jS(k,j)*i^{\underline{j}}\\
  &=\sum_jS(k,j)*\sum_{i=j}^n\binom{n}{i}*i^{\underline{j}}\\
  &=\sum_jS(k,j)*\sum_{i=j}^n\binom{n-j}{i-j}*\frac{n!}{(n-j)!}\\
  &=\sum_jS(k,j)*\frac{n!}{(n-j)!}*\sum_{i=j}^n\binom{n-j}{i-j}\\
  &=\sum_jS(k,j)*\frac{n!}{(n-j)!}*2^{n-j}
  \end{align}
  $$

- 这道题就做完了，时间复杂度$O(k^2)$。


#### 扩展

- 用上文提到的求一行斯特林数的方法可以做到$O(klogk)$​​​。

- 其实我们可以进一步拆解第二类斯特林数，得到：

- $$
  \begin{align}
  &\sum_jS(k,j)*\frac{n!}{(n-j)!}*2^{n-j}\\
  =&\sum_{j<=k}\sum_{i=0}^j\frac{(-1)^{j-i}*i^k}{i!*(j-i)!}*\frac{n!}{(n-j)!}*2^{n-j}\\
  =&\sum_{j<=k}\sum_{i=0}^j\binom{n}{j}*\binom{j}{i}*(-1)^{j-i}*i^k*2^{n-j}\\
  =&\sum_{i=0}^k(-1)^i*i^k*2^n*\sum_{j=i}^k\binom{n}{j}*\binom{j}{i}*(-1)^j*2^{-j}\\
  =&\sum_{i=0}^k(-1)^i*i^k*2^n*\binom{n}{i}*\sum_{j=i}^k\binom{n-i}{n-j}*(-\frac{1}{2})^j\\
  \end{align}
  $$

- 这里看似是一个二重循环，但是我们设$f(i)=\sum_{j=i}^k\binom{n-i}{n-j}*(-\frac{1}{2})^j$，发现可以$O(1)$用$f(x)$求出$f(x-1)$，这样只需要求出$f(k)$就可以$O(k)$求出所有的值了！

- 时间复杂度是线性的。











## 自然数幂和

### 定义

- 求$S_k(n)=\sum_{i=1}^ni^k$。



### 当k比较小时

- $S_0(n)=n$
- $S_1(n)=\frac{n(n+1)}{2}$
- $S_2(n)=\frac{n(n+1)(2n+1)}{6}$
- $S_3(n)=S_1^2(n)$

- $$...$$



### 如何推导？

- 我们想要求$S_k(n)$。

- 这个时候我们考虑扰动一下：

- $$
  \begin{align}
  S_k(n)&=\sum_{i=1}^ni^k\\
  &=\sum_{i=1}^n(i+1)^k-(n+1)^k+1\\
  &=\sum_{i=1}^n\sum_{j=0}^k \binom kj i^j-(n+1)^k+1\\
  &=\sum_{j=0}^k \binom kj S_j(n)-(n+1)^k+1
  \end{align}
  $$
  
- 看上去只要移项，就可以求出$S_k(n)$的递推式了，但我们遗憾地发现，移项完毕后$S_k(n)$被消掉了，但是不要灰心，我们发现$S_k(n)$被消掉以后就可以求出$S_{k-1}(n)$的递推式了！

- 所以：

- $$
  S_{k-1}(n)=\frac{(n+1)^k-1-\sum_{i=0}^{k-2}\binom ki S_i(n)}{k}
  $$

- 我们可以$O(k^2)$求出自然数幂和。

- 发现上述式子有卷积的形式，所以可以考虑分治FFT$O(k*log^2k)$。



### 更快的做法？

- 运用一下生成函数的知识。
- 如果我们把$n^k$表示成$[x^k]e^{nx}*k!$，那么$\sum_{i=0}^{n-1}i^k=\sum_{i=0}^{n-1}[x^k]e^{ix}*k!$。
- 通过等比数列求和可以得到$\sum_{i=0}^{n-1}i^k=[x^k]\frac{1-e^{nx}}{1-e^x}*k!$。
- 这样子我们就可以达到$O(k*logk)$的时间复杂度。

---

- 考虑拉格朗日插值法。
- 我们发现$S_k(n)$是一个$k+1$次多项式，所以我们可以使用拉格朗日插值法。
- 找到$k+2$个比较小的$n'$，求出它们的$S_k(n')$，就可以求出$S_k(n)$的多项式通解了！
- 求$S_k(n')$可以使用筛法来求。
- 这样总时间复杂度就是$O(k)$​​的了！



### 梅开二度

- 我们来看一看这道题：

- $$
  \sum_{i=1}^n\binom{n}{i}*i^k
  $$

- 很明显我们也可以把$i^k$转化成$[x^k]e^{ix}*k!$的形式：

- $$
  \begin{align}
  &\sum_{i=1}^n\binom{n}{i}*i^k\\
  =&\sum_{i=1}^n\binom{n}{i}*[x^k]e^{ix}*k!\\
  =&k!*[x^k]\sum_{i=1}^ne^{ix}*\binom{n}{i}\\
  =&k!*[x^k](e^x+1)^n\\
  \end{align}
  $$

- 这样子就可以做到$O(klogk)$​​的时间复杂度了，虽然比线性差一点。

- 当然，这个式子也可以推到和斯特林数那个一样的式子$(e^x+1)^n=((e^x-1)+2)^n$。











## 伯努利数

### 引入

- 伯努利数和自然数幂和有关。



### 普通形式

- 考虑把$\sum_{i=0}^{n-1}i^k$​的值用有关$n$​的函数表示出来，
- 发现：
- $k=0,S(n)=n$
- $k=1,S(n)=\frac{1}{2}n^2-\frac{1}{2}n$​
- $k=2,S(n)=\frac{1}{3}n^3-\frac{1}{2}n^2+\frac{1}{6}n$​
- $k=3,S(n)=\frac{1}{4}n^4-\frac{1}{2}n^3+\frac{1}{4}n^2+0n$​
- $……$
- 通过OIer高超的找规律能力，我们可以发现这个式子可以表示成以下形式：
- $S(n)=\frac{1}{k+1}\sum_{i=1}^{k+1}\binom{k+1}{i}*B_{k-i+1}*n^{i}$​
- 其中$B_i$​就是伯努利数。



- $$
  \begin{align}
  &[x^k]k!*\frac{e^{nx}-1}{x}*\frac{x}{e^x-1}\\
  =&k!*\sum_{i=0}^k[x^i]\frac{e^{nx}-1}{x}*\frac{B_{k-i}}{(k-i)!}\\
  =&k!*\sum_{i=0}^k[x^{i+1}](e^{nx}-1)*\frac{B_{k-i}}{(k-i)!}\\
  =&k!*\sum_{i=0}^k\frac{n^{i+1}*B_{k-i}}{(i+1)!*(k-i)!}\\
  =&\frac{1}{k+1}\sum_{i=0}^kn^{i+1}*B_{k-i}*\binom{k+1}{i+1}
  \end{align}
  $$



### 伯努利数与组合数的一些关系

- 尝试让$n=1$​​，可以得到$0=\frac{1}{k+1}\sum_{i=1}^{k+1}\binom{k+1}{i}*B_{k-i+1}$​​。

- 用$k$​代替$k+1$​，可以得到$0=\frac{1}{k}\sum_{i=1}^k\binom{k}{k-i}*B_{k-i}$​，也就是说$0=\sum_{i=0}^{k-1}\binom{k}{i}*B_i$​​。

- 同时我们也可以得到伯努利数的递推式：

- $$
  \begin{align}
  \sum_{i=0}^{k}\binom{k+1}{i}*B_i&=0\\
  \sum_{i=0}^{k-1}\binom{k+1}{i}*B_i&=-\binom{k+1}{k}*B_k\\
  \sum_{i=0}^{k-1}\binom{k+1}{i}*B_i&=-(k+1)*B_k\\
  \sum_{i=0}^{k-1}\frac{(k+1)!}{i!*(k+1-i)!}*B_i&=-(k+1)*B_k\\
  -\sum_{i=0}^{k-1}\frac{1}{i!*(k+1-i)!}*B_i&=\frac{B_k}{k!}
  \end{align}
  $$

- 直接分支NTT或许可以达到$O(n*log^2n)$的时间复杂度。



### 生成函数形式

- 刚才自然数幂和已经提到过，其实$S_k(n-1)=[x^k]k!*\frac{e^{nx}-1}{e^x-1}$。

- 而实际上如果有一EGF$F(x)=\sum_{i}\frac{B_i*x^i}{i!}$，那么$F(x)=\frac{x}{e^x-1}$，也就是上面式子的分母部分。

- 为什么它的分母不是$1$而是$x$？

- 这是由于$e^x-1$的常数项为1，如果分子为$1$的话就无法求逆。

- 实际上从这个也可以推到普通的形式：

- $$
  \begin{align}
  &[x^k]k!*\frac{e^{nx}-1}{x}*\frac{x}{e^x-1}\\
  =&k!*\sum_{i=0}^k[x^i]\frac{e^{nx}-1}{x}*\frac{B_{k-i}}{(k-i)!}\\
  =&k!*\sum_{i=0}^k[x^{i+1}](e^{nx}-1)*\frac{B_{k-i}}{(k-i)!}\\
  =&k!*\sum_{i=0}^k\frac{n^{i+1}*B_{k-i}}{(i+1)!*(k-i)!}\\
  =&\frac{1}{k+1}\sum_{i=0}^kn^{i+1}*B_{k-i}*\binom{k+1}{i+1}
  \end{align}
  $$

- 同时，我们也可以通过它的EGF形式来得到一个$O(n*logn)$求伯努利数的做法。

- 但最快的做法，可以通过上文所讲的线性求自然数幂和的方法来求出伯努利数。











## 划分数

### 定义

- 有n个无区别的物品，将它们划分成m组，求出划分方法数。



### 怎么求？

- 设答案为$f[n][m]$。
- 可以得到转移式$f[n][m]=\sum_{i=0}^mf[n-m][i]$。
- 用前缀和维护一下即可做到$O(n^2)$。





- 但是如果我们不对$m$进行限制，也就是说可以分成任意多的组，那么还是只能$O(n^2)$吗？
- 考虑生成函数：
- 有一个物品的组：$1+x+x^2+x^3+...=\frac{1}{1-x}$。
- 有两个物品的组：$1+x^2+x^4+x^6+...=\frac{1}{1-x^2}$。
- 有三个物品的组：$1+x^3+x^6+x^9+...=\frac{1}{1-x^3}$。
- ......
- 我们设$F(x)=\sum_{i=0}a_ix^i$，其中$a_i$表示$n=i$时的方案数。
- 那么$F(x)=\prod_{i=1}\frac{1}{1-x^i}$。
- 所以，如果我们求出了$\prod_{i=1}(1-x^i)$，然后求个逆，就可以得出$F(x)$​了。



### 如何求$\prod_{i=1}(1-x^i)$

- 考虑它的组合意义：对于$x^p$的系数，就是把$p$个无区别物品分进任意多个集合中，但每一个集合内物品的数量**两两不同**。
- 但注意对于每一个方案，如果集合的数量为奇数，那么贡献是$-1$，否则如果数量为偶数，那么贡献是$1$。
- 乍看这个组合意义好像和一开始的差不多，真的会更容易求吗？
- 注意到一个非常关键的性质：奇数为$-1$，偶数为$1$，那么我们是否能把它们抵消掉呢？
- 接下来的转化非常巧妙：
- 我们先把每个集合按所含物品按从多到少排序。
- 比如：(7,6,5,4,3,2)，共6个集合，27个物品。
- 我们把最后一个集合去掉，但要保证物品总数不变，所以我们就把最后一个集合的物品分配到前面去。
- 为了不进行过多扰动，使得序列在分配完后仍是从大到小排好序的，显然从前往后一个一个加：
- (7,6,5,4,3,2)->(8,7,5,4,3)
- (7,6,5,4,3)->(8,7,6,4)
- 假如像(8,7,6,4)这种变成了(9,8,7,1)，还有一个没有分配怎么办？
- 那就不把最后一个集合去掉，因为这种划分方式可以由某种划分方式通过去掉最后一个集合得到。
- (8,7,6,4)<-(7,6,5,4,3)
- 那么，之前的“括号问题”一样，所有划分方案形成了一对一对的映射关系。
- 而且！！！每一对必有一个集合数量为奇数，另一个集合数量为偶数。
- 所以，它们相互抵消了！！！
- 等等！有反例！
- (7,6,5,4)怎么由其它划分方法变过来呢？发现没有。
- 经过总结，我们发现像$(2n-1,2n-2,...,n)$这样的划分方案刚好没有“伴侣”。
- 同样的，还有一种$(2n,2n-1,...,n+1)$也没有“伴侣”（可以参考(8,7,6,5))。
- 7+6+5+4=22，也就是说$p=22$的时候刚好$x^p$的系数为$1$。
- 同样的，5+4+3=12，所以$p=12$时$x^p$的系数为$-1$。
- 就在这时，我们又发现了一个重要的性质：系数不为$0$的$x^p$不是很多，$p\in[1,c]$时只有$O(\sqrt{c})$个满足条件。
- 这个结论是显然的。
- 我们通常称满足条件的$p$为“五边形数”，当然这个问题和五边形没什么关系。
- 这样的话，我们就可以把$\prod_{i=1}(1-x^i)$求出来了，求逆即可。
- 当然，假如你觉得打FFT很麻烦，可以直接暴力求逆，因为非零项只有根号数量。



### 暴力

- 如果直接暴力，可以得到$\prod_{i=1}\frac{1}{(1-x^i)}=exp(ln(\prod_{i=1}\frac{1}{1-x^i}))=exp(\sum_{i=1}ln\frac{1}{1-x^i})$​。
- 对于$ln\frac{1}{1-x^i}$​​，可以得到$\sum_{j=1}\frac{x^{ij}}{j}$​​，发现可以对于每一个$i$​​只有$n/i$​​​个非零项，可以$O(n*logn)$​​​来实现。
- 最后exp也是$O(nlogn)$的。这个有点像“改版Polya指数”。



### 一个奇奇怪怪的东西

- 在每一个划分方案中出现次数不小于$k$的数的种类个数的和等于所有划分方案中$k$的出现次数。
- 不过好像没有什么用。











## 欧拉数

### 前言

- 没错，欧拉又来了~



### 定义

- $A(n,m)$表示有多少个$n$的排列使得满足$p_i<p_{i+1}$的数量为$m$​。



### 如何求？

- ~~可以用$O(n!)$的时间复杂度来求。~~
- 考虑类似于一般组合数的递推，我们从$n-1$的答案扩展到$n$的答案。
- 现在我们要把数$n$插入到$n-1$的排列中，会分为以下几种情况：
  - 如果数字$n$​插入到第一个位置，那么$m$​不会受到任何影响。
  - 如果数字$n$插入到最后一个位置，那么$m$会增加1。
  - 否则，那么它与它的前一个数会让$m$增加1。
    - 如果数字$n$插入到原本$p_i<p_{i+1}$的位置中，那么它会让$m$减少1，也就是$m$​最终不会变。这有$m$种方案数。
    - 否则，最终$m$​会比原来多1，所以原来的$m'=m-1$，有$n-m-1$个方案数。

- 将以上情况总结起来，可以得到递推式$A(n,m)=A(n-1,m-1)*(n-m)+A(n-1,m)*(m+1)$​​。
- 直接做是$O(n^2)$的。



### 更快的做法

- 设$B(n,k)$​表示有多少个$n$​的排列使得满足$p_i<p_{i+1}$​的数量**至少**为$m$​。

- 那么我们可以列出式子：

- $$
  B(n,k)=\sum_{i=k}A(n,i)*\binom{i}{k}
  $$

  

- 稍微容斥一下就可以得到：$A(n,k)=\sum_{i=k}(-1)^{i-k}*B(n,i)*\binom{i}{k}$。

- 接下来考虑如何计算$B(n,m)$，发现假如用普通的方法做也是不太行的，我们需要动用生成函数这个强大的工具。

- 我们考虑把满足$p_i<p_{i+1}$的两个相邻的点之间连一条边，最后发现至多有$n-k$的连通块。

- 每一个连通块我们用EGF表示，也就是$e^x-1$（之所以用EGF表示是因为我们需要给每一个连通块中的点分配标号）。

- 那么既然可以用$n-k$​个连通块来表示，最终的生成函数就是$(e^x-1)^{n-k}$​，答案就是$[x^n](e^x-1)^{n-k}*n!$​。

- ~~这显然可以用多项式快速幂来求。~~

- 考虑把这个式子拆开，

- $$
  \begin{align}
  &n!*[x^n](e^x-1)^{n-k}\\
  =&n!*[x^n]\sum_{i=0}^{n-k}\binom{n-k}{i}*(-1)^{n-k-i}*e^{ix}\\
  =&\sum_{i=0}^{n-k}\binom{n-k}{i}*(-1)^{n-k-i}*i^n\\
  =&\sum_{i=0}^{n-k}\frac{(n-k)!}{i!*(n-k-i)!}*(-1)^{n-k-i}*i^n
  \end{align}
  $$

- 发现做一遍NTT就可以求出一整行的$B$。

- 至于$B$已经求出来了，那么$A$也可以用NTT来求出来，最终的时间复杂度就是$O(n*logn)$​​了！



### 还有更快的做法吗？

- 以上做法对于求一整行的欧拉数时间复杂度是可以的，但如果只求一个$A$的话就会特别亏。

- 如果我们把求$B$的式子和求$A$的式子合并在一起，会有什么神奇的发现吗？

- $$
  \begin{align}
  A(n,k)&=\sum_{i=k}(-1)^{i-k}*B(n,i)*\binom{i}{k}\\
  &=\sum_{i=k}(-1)^{i-k}*\binom{i}{k}*\sum_{j=0}^{n-i}\frac{(n-i)!}{j!*(n-i-j)!}*(-1)^{n-i-j}*j^n\\
  &=\sum_{j=0}^{n}j^n*\sum_{i=k}^{n-j}\binom{i}{k}*\frac{(n-i)!}{j!*(n-i-j)!}*(-1)^{n-k-j}\\
  &=\sum_{j=0}^{n}j^n*(-1)^{n-k-j}*\sum_{i=k}^{n-j}\binom{i}{k}*\binom{n-i}{j}\\
  &=\sum_{j=0}^{n}j^n*(-1)^{n-k-j}*\binom{n+1}{k+j+1}\\
  \end{align}
  $$

- 发现可以直接用$O(n)$来求出单个$A$。



### 另一个做法

- 考虑对于$p_i$把整数域扩展到实数域，那么每一种排列数与数之间的大小关系对应扩散到一个$\frac{1}{n!}$的部分。

- 也就是说，我们把所有$p_i$​在$(0,1)$​中随机一个实数代入，这个$p$​的偏序关系会等概率和某一个$n$​​的排列相同（不考虑相等）。

- 现在我们考虑如何转化"$p_i<p_{i+1}$的数量为$m$​"这个条件。

- 有一个巧妙的做法就是将$p$​​数组差分，假设$b_i=p_i-p_{i-1}(p_0=0)$​，对于$p_i>p_{i+1}$​的，也就是$b_{i+1}<0$​，我们可以让$b_{i+1}$​加上1。

- 如果不加1的话，$\sum b_i=p_n \in(0,1)$​，加上了以后就会变成$\sum b_i=p_n \in (n-m,n-m+1)$。

- 随机$p$也就是随机$b$，那么问题就转化成了：$b$的总和为某一段区间的概率为多少？

- 直接做很麻烦，但是传统艺能我们可以求$\sum b_i \in (0,r)$的概率然后相减一下。

- 这个时候我们再次上容斥原理，把$b_i \in (0,1)$的这个条件去掉，就可以得到式子：

- $$
  Ans(r)=\sum_{i=0}^n(-1)^i*\binom{n}{i}*f(r-i)
  $$

- 其中$Ans(r)=\sum b_i \in (0,r)$的概率，$f(k)$表示不考虑$b$的范围，总和为$k$的概率。

- 怎么求$f(k)$呢？我们可以从挡板问题的角度思考，只不过现在每一个挡板放置的位置是一个实数，我们也就可以直接让每一个挡板在$[0,k]$中随机一个位置，但由于挡板本身是无标号的，最后要除以$n!$。

- 也就是$f(k)=\frac{k^n}{n!}$。

- 那么我们也就再次找到了一个可以$O(n)$求出单个欧拉数的方案数，并且这个东西显然可以卷，也就可以$O(nlgn)$求出一行欧拉数。



### 小模板题

- 来源：CF1349F
- 题目大意：定义一个长度为$n$序列$a$​为"好序列"，当且仅当对于任意出现在$a$中的数$k$，存在两个数$i,j(i<j)$使得$a_i=k-1,a_j=k$。要求对于每一个$x$输出这个数在所有好序列中出现的次数。
- $n<=5000$

#### solution

- 由于这道题放在欧拉数的部分，我们已经知道要用什么知识点了，所以难度降低了很多。

- 考虑如何往欧拉数上凑，发现对于一个从1到n的序列$p(p_i=i)$，如果我们按照$a_{p_i}$为第一关键字从小到大，$p_i$为第二关键字从大到小，会得到一个$n$的排列$p'$。反过来，如果我们知道$p'$，然后对于所有$p_i<p_{i+1}$​的位置，我们把它从中间切开，最后会剩下一些区间，其中每一个区间都是一个**严格单调下降**的序列，对于同一个区间中的$p_i$，我们对$a_{p_i}$填上同样的数，并且每个区间从左到右依次填$1,2,3,...$。

- 这样从$a$可以到达唯一一个$p$，从$p$也可以唯一到达一个$a$，并且$a$与$p$是一一映射的关系。

- 那么一个数$x$的答案就是它在所有$p$​中对应区间的长度和。

- 直接求区间长度比较困难，所以还是每一个数在每一个位置的出现次数，这样就很好统计了。

- 一个数$x$在$p_i$中出现（即$a_{p_i}=x$）的次数为：

- $$
  A(i,x-1)*\frac{n!}{i!}
  $$

- 直接做就是$O(n^2)$的。











## 贝尔数

### 定义

- 贝尔数$B_n$指的是将$n$个有标号元素拆分成任意个数集合的方案数。
- 迅速得到等式：$B_n=\sum_{i=0}^nS(n,i)$。



### 如何求贝尔数

- 除了上文中提到的用斯特林数求之外，它还和组合数有一点关系：

- 采用增量法，考虑如何从$B_{0...n}$推到$B_{n+1}$，从它的组合意义切入，我们可以枚举有多少个点和新加进去的$n+1$号点在同一个集合内，那么最终的式子是这样的：

- $$
  B_{n+1}=\sum_{i=0}^n\binom{n}{i}*B_{n-i}
  $$

- 这个显然可以$O(n^2)$求，用分治NTT则可以达到$O(n*log^2n)$的时间复杂度。

- 当然这个东西可以继续求解：

- $$
  \begin{align}
  B_{n+1}&=\sum_{i=0}^n\frac{n!}{i!*(n-i)!}*B_{n-i}\\
  \frac{B_{n+1}}{(n+1)!}*(n+1)&=\sum_{i=0}^n\frac{1}{i!}*\frac{B_{n-i}}{(n-i)!}\\
  \end{align}
  $$

- 先设$G(x)=\sum_i\frac{1}{i!}*x^i$，显然$G(x)=e^x$​。

- 接着再设EGF$F(x)=\sum_{i=0}\frac{B(i)}{i!}*x^i$，把上面的式子翻译成生成函数就是：

- $$
  F'(x)=G(x)*F(x)=e^xF(x)
  $$

- 移项得到$\frac{F'(x)}{F(x)}=e^x$，由于$ln'(F(x))=\frac{F'(x)}{F(x)}$，所以$ln'(F(x))=e^x$。

- 式子两边求积分，可以得到$ln(F(x))=e^x+c$。

- 将$x=0$代入可以得到$c=-1$，所以$ln(F(x))=e^x-1$。

- 两边同时exp以下就可以得到$F(x)=e^{e^x-1}$。

- 做两次exp即可以解得$F(x)$，时间复杂度$O(n*logn)$。

- 考虑一下$e^{e^x-1}$的组合意义，差不多就是先把元素组合成集合，然后再把多个集合组合在一起的过程。



### Touchard同余

- 一个不怎么知名的东西：

- 
  $$
  B_{n+p} \equiv B_{n}+B_{n+1}(mod~p)
  $$

- 其中$p$是一个质数。

- 简单证明一下吧。

  - 引理：对于质数$p$，$\forall m\in (1,p),S(p,m) \equiv 0(mod~p)$。

  - 证明：考虑使用第二类斯特林数的通项公式：

  - $$
    S(n,m)=\sum_{i=0}^m\frac{(-1)^{m-i}*i^n}{i!(m-i)!}\equiv \sum_{i=0}^m\frac{(-1)^{m-i}*i}{i!*(m-i)!}(mod~n)
    $$

  - 进一步化简得到：

  - $$
    \begin{align}
    &\sum_{i=0}^m\frac{(-1)^{m-i}*i}{i!*(m-i)!}\\
    =&\sum_{i=0}^m\frac{(-1)^{m-i}}{(i-1)!*(m-i)!}\\
    =&\frac{1}{(m-1)!}*\sum_{i=0}^{m-1}(-1)^{m-i-1}*\binom{m-1}{i}\\
    =&[m-1==0]
    \end{align}
    $$

  - $m=p$时比较特殊不适用于上面推的式子，因此当$m\in(1,p)$时$S(p,m)\equiv0(mod~p)$。

- 对于$B_{n+p}$​​，我们考虑它的组合意义，先把它拆成“n个”和“p个”两部分，我们先把“p个”的分好组（假设有x个组），然后枚举“n个”的这一堆中有多少个不与那“p个”合并，与“p个”合并的每一个可以进入x个集合中的任意一个。

- $$
  B_{n+p}=\sum_{x=1}^pS(p,x)\sum_{i=0}^n\binom{n}{i}*B_i*x^{n-i}
  $$

- 根据引理，$x=1,p$时$S(p,x)$才不为$p$的倍数，所以（注意$S(p,1)=S(p,p)=1$）：

- $$
  B_{n+p}\equiv\sum_{i=0}^n\binom{n}{i}*B_i+\sum_{i=0}^n\binom{n}{i}*B_i*p^{n-i}(mod~p)
  $$

- 加号左边刚好就是$B_{n+1}$的递推式，右边只有当$n-i=0$时才有效，因此：

- $B_{n+p}\equiv B_{n+1}+\binom{n}{n}*B_n*p^0=B_{n+1}+B_{n}(mod~p)$。











## 容斥原理

### 何为容斥？

- 有一些题目，常常会给出多个条件。比如假设有两个条件$A,B$，问满足这两个条件中至少一个的方案数有多少？

- 假设满足条件$A$的方案数为$x$，满足条件$B$的方案数为$y$，那么$x+y$是否就是答案呢？

- 答案显然是否，因为可能会有一些方案既满足条件$A$，又满足条件$B$，这样就会算重。

- 所以如果两个条件都符合的方案数为$z$，那么答案应该是$x+y-z$。

- 当然这是最简单的情况，一般地，如果有$n$个条件，那么满足至少一个条件的方案数为：

- $$
  |\bigcup_{i=1}^nf(i)|=\sum_{i=1}^n(-1)^{i-1}\sum_{|S|=i}|\bigcap_{e \in S}f(e)|
  $$

- 其中$f(i)$表示满足第$i$个条件的方案集合。

- 稍微证明一下，假如某一个方案符合其中的某$k$个条件。

- 那么式子中当$i=1,2,3,...,k$时，它分别会被计算$\binom{k}{1},\binom{k}{2},\binom{k}{3},...,\binom{k}{k}$次。

- 由于某些要乘-1，所以最后会被算$\binom{k}{1}-\binom{k}{2}+\binom{k}{3}-...\pm\binom{k}{k}=[k \neq 0]$。

- 你会发现，$\sum_{i=0}^n(-1)^i*\binom{n}{i}=[n==0]$这个定理发挥了关键的作用，并且在接下来的一系列容斥中这个定理也非常重要。

- 类似的，如果有$n$个条件，那么满足所有条件的方案数为：

- $$
  M-|\bigcup_{i=1}^ng(i)|=M-\sum_{i=1}^n(-1)^{i-1}\sum_{|S|=i}|\bigcap_{e \in S}g(e)|
  $$

- 其中$g(i)$表示**不满足**第$i$个条件的方案集合，$M$表示方案的总个数。

- 经典例题：

- 求满足条件的长度为$n$的序列$A$的个数，其中$A$要满足以下两个条件：

- $A_1+A_2+A_3+...+A_n=m$

- $A_i\in[l,r](1\leq i\leq n)$

- $n,m\leq 10^6$

- 假如没有$r$的限制，就是简单的挡板问题。

- 考虑运用容斥来解决掉$r$的限制，发现可以套用公式2。问题变为有$i$个位置一定要超过$r$的限制，剩下$n-i$个位置随便填，求方案数。

- 这样就把上限变为了下限，经典的挡板问题。

---

- ![屏幕截图 2021-06-11 151210](D:\冯启豫\fengqiyu\计数\计数\屏幕截图 2021-06-11 151210.png)
- 乍看或许看不出什么，但仔细观察发现式子和容斥的式子一模一样！
- $\sum_{i=1}^n(-1)^{i-1}\sum_{|S|=i}|\bigcap_{e \in S}f(e)|$，其中$S$就是边集，$f(e)$就是满足$e$两个端点颜色相同的方案集合。
- 这样就可以得到$|\bigcup_{i=1}^nf(i)|$，也就是说只要存在两个点颜色相同即可！
- 答案即为$m^n-\frac{m!}{n!}$。



### 广义容斥原理

- 要求恰好满足$m$​个条件的方案数。
- 我们可以先设$g_i$表示计算 至少满足$i$个条件 的方案数时所用的容斥系数。
- 那么对于一种 恰好满足$j$​​个条件 的方案，它会被统计到的次数为$\sum_{k=1}^j\binom{j}{k}*g_k$​​，我们希望当且仅当$j=m$​时这个式子的值为1，其余全部为0。
- 在具体的实践中我们可以直接利用计算机~~多项式求逆~~来得出$g$具体的值，但我们也可以通过数学的角度来推式子。
- 先把组合数用阶乘展开，得到$\sum_{k=1}^j\frac{j!}{k!*(j-k)!}*g_k$。
- 考虑和普通容斥原理一样使用$\sum_{i=0}^n(-1)^i*\binom{n}{i}=[n==0]$，稍微改一下即可变成$\sum_{i=0}^{n-k}(-1)^i*\binom{n-k}{i}=[n==k]$

- 回到之前的式子，要是能把$\binom{j}{k}$变成$(-1)^y*\binom{j-m}{x}$的形式就好了，那么考虑把$\binom{j}{k}$通过乘$\frac{k!}{(k-m)!}$变为$\frac{j!}{(j-m)!}*\binom{j-m}{k-m}$，虽然组合数前面多乘了一个数，但对于一个固定的$j$​来说是常数，加入整个式子的值为0，那么乘上一个常数以后也为0。
- 唯一需要注意的是当$j=m$时整个式子的值原本应是1，但因为乘了一个常数变成了$m!$，不过我们只要在整个式子上出一个$m!$就可以了。
- 再乘上-1，最终的容斥系数就得出来了：$g_k=(-1)^{k-m}*\frac{k!}{(k-m)!*m!}=(-1)^{k-m}*\binom{k}{m}$。



### 自定义容斥系数

- 有的时候，题目的要求是比较奇怪的，这样直接用数学的方法推式子就行不通了，但我们可以利用电脑算出容斥系数。

- 其实也非常简单，我们发现答案形如下式：

- $$
  \sum_{i=k}^nb_i*\sum_{|S|=i}|\bigcap_{e \in S}g(e)|
  $$

- 其中$b_i$是不知道的，但我们可以推出来，这样就可以照常容斥了！



### 容斥小反演

- 如果$f(S)=\sum_{T\in S}g(T)$。

- 那么$g(S)=\sum_{T\in S}(-1)^{|S|-|T|}f(T)$。

- 证明的话用基本套路：

- 

- 

- $$
  \begin{align}
  g(S)&=\sum_{T\subseteq S}(-1)^{|S|-|T|}f(T)\\
  &=\sum_{T\subseteq S}(-1)^{|S|-|T|}\sum_{U\subseteq T}g(U)\\
  &=\sum_{U\subseteq S}g(U)\sum_{U\subseteq T\subseteq S}(-1)^{|S|-|T|}\\
  &=\sum_{U\subseteq S}g(U)\sum_{T\subseteq S-U}(-1)^{|S|-|U|-|T|}\\
  &=\sum_{U\subseteq S}g(U)\sum_{i=0}^{|S|-|U|}\sum_{|T|=i}(-1)^{|S|-|U|-i}\\
  &=\sum_{U\subseteq S}g(U)\sum_{i=0}^{|S|-|U|}\binom{|S|-|U|}{i}*(-1)^{|S|-|U|-i}\\
  &=\sum_{U\subseteq S}g(U)*[|S|-|U|==0]=g(S)
  \end{align}
  $$



### 二项式小反演

- 如果$f_n=\sum_{i=0}^n(-1)^i*\binom{n}{i}*g_i$。

- 那么$g_n=\sum_{i=0}^n(-1)^i*\binom{n}{i}*f_i$。

- 基本套路：

- 
  $$
  \begin{align}
  g_n&=\sum_{i=0}^n(-1)^i*\binom{n}{i}*f_i\\
  &=\sum_{i=0}^n(-1)^i*\binom{n}{i}*\sum_{j=0}^i(-1)^j*\binom{i}{j}*g_j\\
  &=\sum_{j=0}^ng_j*\sum_{i=j}^n(-1)^{i+j}*\binom{n}{i}*\binom{i}{j}\\
  &=\sum_{j=0}^ng_j*\sum_{i=j}^n(-1)^{i+j}*\binom{n}{n-j}*\binom{n-j}{i-j}\\
  &=\sum_{j=0}^ng_j*\binom{n}{n-j}*\sum_{i=0}^{n-j}(-1)^{i+2*j}*\binom{n-j}{i}\\
  &=\sum_{j=0}^ng_j*\binom{n}{n-j}*[n-j==0]=g_n
  \end{align}
  $$
  
- 这也启示我们假如想要推出反演的式子，例如已知$f_n=\sum_{i=0}^n(-1)^i*\binom{n}{i}*g_i$。

- 设$g_n=\sum_{i=0}^nb_i*f_i$。

- 那么$g_n=\sum_{i=0}^nb_i\sum_{j=0}^i(-1)^j*\binom{i}{j}*g_j=\sum_{j=0}^ng_j\sum_{i=j}^n(-1)^i*\binom{i}{j}*b_i$。

- 因为$g_n=\sum_{i=0}^ng_i*[n==i]$。

- 所以$\sum_{i=j}^n(-1)^i*\binom{i}{j}*b_i=[n==j]$。

- 这样子就可以把$b$​推出来了！

---

- 二项式反演还有一个小扩展，就是当$f_n=\sum_{i=0}^n\binom{n}{i}*g_i$时，如何用$f$来表示$g$？
- 发现就是原来的$(-1)^i*g_i$变成$g_i$，那么只需要在原来$g_n=\sum_{i=0}^n(-1)^i*\binom{n}{i}*f_i$上多乘一个$(-1)^n$即可。
- 也就是$g_n=\sum_{i=0}^n(-1)^{n+i}*\binom{n}{i}*f_i$。



### min-max小反演

- $max(S)=\sum_{T\subseteq S}(-1)^{|T|-1}*min(T)$
- $min(S)=\sum_{T\subseteq S}(-1)^{|T|-1}*max(T)$
- 证明与上文类似。
- 这个反演经典之处在于它适用于期望。证明也不难，只要明白这里的min/max使用加法表示的，并且期望满足线性加就很自然了。
- 小问题：如何运用类似的方法求出第$k$大值？
- 这就是极其简单的“自定义容斥系数”的问题（见上文）。
- 当然，推出容斥系数以后你就会发现它也是一个组合数：
- $maxkth(S)=\sum_{T\subseteq S}(-1)^{|T|-k}*\binom{|T|-1}{k-1}*min(T)$
- $minkth(S)=\sum_{T\subseteq S}(-1)^{|T|-k}*\binom{|T|-1}{k-1}*max(T)$
- 关于这个反演，有一道非常经典的例题：
- ![屏幕截图 2021-06-11 151751](D:\冯启豫\fengqiyu\计数\计数\屏幕截图 2021-06-11 151751.png)
- $n<=18,Q<=5000$
- 这个问题的关键在于转化，题目所求的是“都经过”，也就是对于一个集合$S$，集合内部所有点经过时间的最大值。
- 发现最大值很难求，又考虑到$n$特别小，所以可以考虑min-max反演。
- 那么对于一个点集，我们该怎么求最小值呢？
- 考虑树上简单期望DP，解方程即可。



### 集合小反演

- 若$f(S)=\sum_{T \subseteq S}g(T)$，那么$g(S)=\sum_{T \subseteq S}(-1)^{|S|-|T|}*f(T)$。
- 若$f(S)=\sum_{S \subseteq T}g(T)$，那么$g(S)=\sum_{S \subseteq T}(-1)^{|T|-|S|}f(T)$。
- 发现莫比乌斯反演等价于集合反演。
- 证明和上文类似。
- 集合反演一个重要的等式为$[S \subseteq (X \cap Y)]=[S \subseteq X][S \subseteq Y]$​，可以把二维变为一维。
- 可以扩展到可重集合，定义容斥系数$\mu(X)$——和莫比乌斯反演的类似，上面的反演式子只要$(-1)^{|S|-|T|}$变为$\mu(|S|-|T|)$。



### 练练手

#### 错排问题

- 有多少个长度$n$的排列，不存在$i$使得$i=p_i$？
- 先考虑DP$f_i$表示$n=i$时的答案。
- 如果我们把数$n$填到第$i$个位置上，而把数$i$填到第$n$个位置上，那么剩下的$n-2$个数是错排的，考虑到$n$可以填的位置有$n-1$种，所以方案数为$(n-1)*f_{n-2}$。
- 如果我们把数$n$填到第$i$个位置上，但是第$n$个位置上的数不是$i$，那么把第$n$个位置上的数放在第$i$个位置上就是一个长度为$n-1$的错排，考虑到$n$可以填的位置有$n-1$种，所以总方案数为$(n-1)*f_{n-1}$。
- 所以$f_n=(n-1)*(f_{n-1}+f_{n-2})$。
- 当然还有别的方法，显然可以进行简单的容斥：
- 如果有$k$个$i=p_i$，其它位置乱填，那么方案数为$\binom{n}{k}*(n-k)!=\frac{n!}{k!}$。
- 那么方案数为$\sum_{i=0}^n(-1)^i*\frac{n!}{i!}\approx \frac{n!}{e}$。

#### DAG计数

- 求$n$个带标号的点的有向无环图的个数。
- $n<=5000$。
- 如果直接DP，设$f[i][j]$表示有$i$个点，$j$个点出度为0的方案数。
- 那么可以得到转移式$f[i][j]=\sum_{k=0}^{i-j}f[i-j][k]*\binom{i}{j}*(2^j-1)^k*2^{(i-j-k)*j}$，时间复杂度$O(n^3)$。
- 发现瓶颈在于我们需要知道上一轮度数为零的点的个数，因为这些点每一个都必须要在这一轮翻身成为度数不为零的点（即和这$j$个点中的**至少一个**连边）。
- 这是不是与容斥模型很类似呢？
- 考虑一个DAG如果有$j$个度数为0的点，我们怎么把它的总容斥系数变为$[j\neq 0]$呢？
- 发现可以转化为$\sum_{k=1}^j(-1)^{k-1}\binom{j}{k}$。
- 这样子我们就可以把“恰好”$j$个度数为0的点转化为“至少”$j$个度数为0的点。
- $f[i]=\sum_{j=1}^i(-1)^{j-1}*\binom{i}{j}*f[i-j]*2^{(i-j)*j}$。
- 时间复杂度$O(n^2)$​。











## 群论

### 引入

- 有的时候，在某些条件下一些方案是同构的，只能算作一种。
- 假如直接算的话就会算重，又不能用容斥原理去重，该怎么办呢？



### 置换

- 考虑一个极其经典的例题：
- 有一个$n$颗珠子的环状项链，每一颗珠子可以染$m$种颜色中的一种，如果两个方案其中一个可以通过旋转变为另一个，那么这两个方案就是相同的，问总共有多少种不同的方案？
- 我们发现这一道题有一个关键词：旋转。
- 旋转的特殊之处在于它可以表示为一种**置换**。
- 什么是置换？
- 假设有一个$n$的排列$p_1,p_2,p_3,...,p_n$，现在我们有$n$颗珠子，我们把第$i$颗珠子的颜色变为第$p_i$颗珠子的颜色，这就是一种置换，其实也可以直接看作$n$颗珠子之间的一一映射关系。
- 旋转就是一种置换，假如旋转一格，就是将第$i$颗珠子的颜色变为第$i\%n+1$颗珠子的颜色。
- 因此，旋转总共有$n$种置换，分别是顺时针旋转$0,1,2,3,...,n-1$格。（注意，不动本身也是一种置换）
- 所有的这些置换，构成一个置换群。
- 在某一种置换下，有一些情况是比较特殊的，比如有一个4颗珠子的项链，如果它的1和3号珠子为同一种颜色，2和4号珠子也为容易中颜色，那么旋转两格之后整个项链是没有变化的，我们把这种置换后没有变化的方案称为这种置换的**不动点**。



### burnside引理

- 即使知道了旋转是一种置换，又该如何计算方案数呢？

- 现在我们来想一下，如果我们把方案数乘$n$，也就是把每一种不同的方案经过所有$n$种旋转之后得到的所有项链的数量，它会算到在不考虑旋转同构情况时所有的$m^n$种项链，但其中有一些项链会被算到多次，因为在某些旋转下**它会变回它自己**。

- 这不就是不动点的定义吗？

- burnside引理的公式：

- $$
  |G|*Ans=\sum_{i=1}^{|G|}f(G_i)
  $$

- 其中$G$表示置换的集合，$f(G_i)$表示第$i$种置换下不动点的个数。

- 这样子就很好理解了，因为我们需要加上被算多次的项链，所以我们要把每一种置换的不动点个数加起来，就可以得到方案数*置换数的值了。



### 项链问题

- 回到项链问题，我们怎么求每一种置换的不动点。
- 可以简单发现，对于有$n$颗珠子的项链，如果我们旋转$k$格，那么所有珠子会被分成$gcd(n,k)$组，每一组的点必须要填同一种颜色，更准确地来说，每一个点是按编号$i\%gcd(n,k)$来分组的。
- 也就是说答案就是$\sum_{k=1}^nm^{gcd(n,k)}$，别忘了最后要除以置换数。



### polya定理

- 没什么好说的，其实就是burnside引理的具体化。

- $$
  |G|*Ans=\sum_{i=1}^{|G|}m^{h(G_i)}
  $$

- 其中$h(G_i)$就是置换$G_i$下会分成多少组，在项链问题中$h(G_i)=gcd(n,i)$。



### lzc的坑

- 有标号的**Cycle构造**是不怎么需要考虑等价类的，对于一个“对象”$A$​，它构成一个大小为$k$​的环除以$k$即可：

- $$
  \begin{align}
  CYC_k(A)&=\frac{A^k(x)}{k}\\
  CYC(k)&=\sum_{k=1}^\infty \frac{A^k(x)}{k}=ln(\frac{1}{1-A(x)})
  \end{align}
  $$

- 无标号的**Cycle构造**就是经典的项链问题：

- 考虑一个大小为$k$的环，它有一个顺时针旋转$i$次的置换，那么会有$gcd(i,k)$个等价类（特别的，$gcd(0,k)=k$），每一个等价类有$\frac{k}{gcd(i,k)}$个等价的珠子。那么对于一个“对象”$A$，一个等价类的GF为$A(x^{k/gcd(i,k)})$，那么所有等价类的GF即为$A(x^{k/gcd(i,k)})^{gcd(i,k)}$。

- 根据Burnside引理，由于有$k$种置换，所以最后要除以$k$，那么大小为$k$环的GF为：

- $$
  \begin{align}
  &\frac{1}{k}*\sum_{i=1}^{k}A(x^{k/gcd(i,k)})^{gcd(i,k)}\\
  =&\frac{1}{k}*\sum_{d|k}\phi(d)*A(x^d)^{k/d}\\
  \end{align}
  $$

- 不限定大小的话，GF就是：

- 
  $$
  \begin{align}
  &\sum_{k=1} \frac{1}{k}*\sum_{d|k}\phi(d)*A(x^d)^{k/d}\\
  =&\sum_{d=1}\phi(d)*\sum_{d|k}\frac{1}{k}*A(x^d)^{k/d}\\
  =&\sum_{d=1}\frac{\phi(d)}{d}*\sum_{i=1}^\infty \frac{A(x^d)^i}{i}\\
  =&\sum_{d=1}\frac{\phi(d)}{d}*ln(\frac{1}{1-A(x^d)})
  \end{align}
  $$

- 一样可以做到$O(n*logn)$的时间复杂度。











## 图上计数1

- 下面所有的图都不能有重边和自环。



### 连通图计数

- 求$n$个有标号点的连通图个数。

- 考虑用总方案数减去不连通的个数。

- 设$f_i$表示$n=i$时答案。

- 那么：

- $$
  f_i=2^{i*(i-1)/2}-\sum_{j=1}^{i-1}\binom{i-1}{j-1}*2^{(i-j)*(i-j-1)/2}*f_j
  $$

- 这个式子理解起来比较简单，就是枚举编号为$i$的点所属的连通块有多少个点。

- 因为要强制这个图不连通，所以这个连通块和其余的点不能有任何边相连。

- 这个连通块以外的点两两之间可以任意选择连或不连，但连通块内的由于需要保证连通，所以方案数是$f_j$。

- 用分治FFT优化可以做到$O(n*log^2n)$，进一步优化甚至可以做到$O(n*logn)$。

#### 加强版

- 求$n$个有标号点的连通图个数，并要求这个图内恰有$m$条边。
- 如果像刚才那样做的话DP要多设一维，时间复杂度是$O(n^2*m^2)$的，能不能进行优化？
- 发现这个做法由于要让编号为$i$所属的连通块连通，还要枚举这个连通块的边数与点数来进行DP，导致浪费了不少时间，那么可不可以不强制让$i$点所属的“连通块”连通？
- 进一步容斥。
- 我们把整个图分成几个“块”，不需要保证块内连通，但要保证块与块之间**没有任何边相连**。
- 尝试算出将一个图分成$i$个块时的容斥系数，发现是$(i-1)!*(-1)^{i-1}$。
- 当然我们也可以推一下：考虑某一种方案有$j$个连通块（连通块是连通的），那么当我们把图分成$i$个块时它会被计算$S(j,i)$次，现在我们要算出容斥系数$a_i$使得$\sum_{i=1}^jS(j,i)*a_i=[j==1]$。
- 考虑斯特林反演，$\sum_{i=1}^jS(j,i)*s(i,1)*(-1)^{j-i}=[j==1]$。
- 那么容斥系数$a_i=s(i,1)*(-1)^{j-i}=(i-1)!*(-1)^{i-1}$。

- 所以我们可以设DP$g_{i,j,k}$，表示有$i$个点，$j$个块，并且可以连的边数为$k$，最后要乘上$\binom{k}{m}$。
- 时间复杂度$O(n^3*m)$。
- 当然，还有一个小技巧，考虑容斥系数$a_i$的组合意义，发现$i$个块的排列有$i!$个，那么假如我们固定住一个块的位置，排列就是$(i-1)!$种了，所以我们可以在DP转移的时候不需要枚举“编号为$i$的点所属的块”，而是任选一个块——除了某一个被”固定“住的块，为了方便计算，我们可以认定这个块包含编号为1的点，保证这个块一定是最先被选即可。
- 至于容斥系数中还有一个$(-1)^{i-1}$，这个转移过程中加号改成减号即可。
- DP转移式为$g_{i,k}=-\sum_{j=1}^{i-1}\binom{i-1}{j}*g_{i-j,k-j*(j-1)/2}$，当然要注意一下初始化，比如$g_{i,i*(i-1)/2}=1$。

- 发现这个DP可以少一维（记录块的个数的那一维），时间复杂度变为$O(n^2*m)$。



### 强连通分量计数

- 求$n$个有标号点的有向图个数，其中这个有向图是一个强连通分量。
- 老套路，总方案数-不合法方案数。
- 容易发现假如把一个强联通分量压缩成一个点，整张图就会变成一个DAG。
- 那么按照计算DAG方案数的方法，我们需要找出一些出度为0的点。
- 假如$h_n$表示$n$个有标号点的有向图的总方案数，那么$h_n=\sum_{i=1}^n\binom{n}{i}*g_i*h_{n-i}$。
- 其中$g_i$表示总共有$i$个点分成若干个强连通分量的方案数（强连通分量的个数任意），至于缺少的（-1）的系数在g数组中填补。
- 那么$g_n=-\sum_{i=1}^n\binom{n-1}{i-1}*g_{n-i}*f_i$，$f_i$就是我们所要求的，$i$个有标号点的强连通分量个数。
- 暴力可以$O(n^2)$求。
- 假如有足够的多项式/生成函数相关知识可以进行优化。



### 二分图计数

- 求$n$个有标号点的二分图个数。
- 一个显然的思路是先将整张图分成两半，再连边。
- 我们设$f_i$表示$i$个点的二分图个数，答案似乎可以求出来：
- $f_n=\sum_{i=0}^n\binom{n}{i}*2^{i*(n-i)}$。
- 但这显然是不正确的，因为一张二分图两边交换一下还是一样的图，但会被计算两次，所以应该为$\frac{f_n}{2}$。
- 不过，这还是错误的——当且仅当这张图不连通的时候。也就是说，当这张图联通时，$\frac{f_n}{2}$确实就是正确答案，所以我们可以用类似求连通图的DP来求一个$f'_n$表示$n$个点的连通二分图个数。
- 但题目本身没有要求连通，所以在给$f'$除以2之后要再做一次DP把多个连通块拼起来。



### 边双连通分量计数

- 求$n$个有标号点的无向图个数，其中这个无向图是一个边双连通分量。
- 和强连通分量类似，如果我们把每一个边双连通分量压缩成一个点，那么整张图就会变成一棵树。
- $n$个点的**有根树**有多少种$g_n$怎么求？原始的暴力就是先固定某一个点为根（这里用1号点），接着考虑$n$号点所在的子树，显然可以得到转移式$g_n=n*\sum_{i=1}^{n-1}g_i*g_{n-i}*\binom{n-1}{i-1}$，乘$n$是因为我们之前固定了某一个点，但其实根是不固定的。
- 回到原问题，考虑先求出$f_i$表示$i$个点的连通图数量，接着固定1号点所在的边双连通分量为根，整棵树会被分成一些子树，发现由于每一个连通无向图经过压缩之后都会变成一种树，所以求树的种类数其实就是求连通无向图的种类数——换句话说，我们可以很容易求出一棵$i$个点的子树有多少个不同种类（即为$i$个点的连通无向图的数量）。
- 我们枚举1号点所在边双连通分量有多少个点（假设数量为$k$）剩下的就是一个简单的树形DP，设$h_i$表示原图的$i$个点压缩之后分成任意数子树的方案数，转移的时候选定编号最大的那个点所在的子树，转移式就是$h_i=\sum_{j=1}^ih_{i-j}*f_j*\binom{i-1}{j-1}*j*k$，其中乘j是因为没有确定这个子树里面哪一个点往上连到根，而乘k的意义类似。
- 那么$f_n=\sum_{i=1}^np_i*h_{n-i}*\binom{n-1}{i-1}$，其中$p_i$是$i$个点的边双连通分量种类数，注意这里的h数组**在i不同的时候是不一样的**，也就是说我们总共要求n次h数组。
- 说了这么多，我们是想要求$p_i$，既然f和h我们都知道，自然就可以把p解出来。
- 其实假如把上述转移式变为$p_n=f_n-\sum_{i=1}^{n-1}p_i*h_{n-i}*\binom{n-1}{i-1}$，发现它其实和连通图计数的转移式是类似的。



### 点双连通分量计数

- 求$n$个有标号点的无向图个数，其中这个无向图是一个点双连通分量。
- 直接把点双连通分量缩成一个点是不太行的，因为一个点可能同时处于多个点双连通分量中。
- 因此，我们改变一下方法，对于一个dfs树的根，我们不把它所处的整个点双连通分量删掉，而是单独把这个点删掉。
- 而对于包含根的那些点双连通分量，我们把它们所有的边全部删掉（**但不要删点**），这样剩下的图就会变成若干个连通块。
- 类似边双连通分量，我们可以进行DP，设$h_i$表示$i$个点分成$j$个连通块的方案数，那么$h_{i,j}=\sum_{k=1}^ih_{i-k,j-1}*f_k*\binom{i-1}{k-1}$，其中$f_j$代表$j$个点连通图的方案数。
- 但是我们怎么把这些连通块串联起来呢？考虑我们现在要进行的是在这些连通块中再次进行分组，使得同一组中的连通块与根合并为一个点双连通分量，可以设一个DP$g_i$表示有$i$个点分成若干个点双连通分量的方案数，那么$g_i=\sum_{j=1}^i\sum_{k=1}^jg_{i-j}*h_{j,k}*\binom{i-1}{j-1}*p_{k+1}$，其中$p_i$表示$i$个点的点双连通分量的方案数。
- 等一等，这里$h_{j,k}$有$j$个点，为什么是乘$p_{k+1}$而不是$p_{j+1}$。
- 因为每一个连通块只能有一个点向外连——回想一下我们删边的过程，同一个点双中的两个点一定不会出现在一个连通块内。
- 但是这意味着每一个连通块我们需要指定一个点向外连，所以转移式变为：$h_{i,j}=\sum_{k=1}^ih_{i-k,j-1}*f_k*\binom{i-1}{k-1}*k$。
- 最后和求边双连通分量一样，并且发现$p_{n+1}=g_n$，我们把p数组解出来即可。



### 仙人掌计数

- 求$n$个有标号点的仙人掌个数。
- 发现可以用类似于点双连通分量计数的方法，考虑以1号点作为根，接着把1号点所在的环所包含的边全部删掉，就会剩下一堆子仙人掌，设$p_i$表示$i$个点的仙人掌个数，再设$f_i$表示$i$个点组成若干个子仙人掌的个数，转移式即为$f_i=\sum_{j=1}^if_{i-j}*p_j*\binom{i-1}{j-1}$。
- 合并的时候我们又要把这些子仙人掌分成若干组，每一组用一个环串起来，发现$i$个子仙人掌和根串成一个环的方案数是$\frac{i!}{2}$的（$i=1$的情况不一样，要特殊处理），假若直接算似乎要记录子仙人掌的个数，但其实假若把转移式改为$f_i=\sum_{j=1}^if_{i-j}*p_j*\binom{i}{j}$，对于一个有$k$个子仙人掌的方案，它就会预先帮你乘上$k!$，原理和“连通图加强版”优化的原理是一样的。
- 最后发现有$p_{n+1}=f_n$，解出$p$即可。



- 值得注意的是，以上的解法虽然看起来时间复杂度不理想，是因为计数只是求解的前半部分，可以用多项式/生成函数对以上方法进行不小的优化。











## 图上计数2

~~30烷有多少同分异构体？（2分）~~



- 想要求出烷烃计数，就需要先知道如何求烷基计数。

### 烷基计数

- 告诉你碳原子的数量，请求出有多少种烷基？
- 解释题意：求有多少种有$n$个无标号点的有根树，并且每一个点最多有3个儿子？
- 先考虑DP，设$f_i$表示$n=i$时的答案。
- 那么是否$f_i=\sum_{x+y+z=i-1}f_x*f_y*f_z$？
- 显然不行，因为这三棵子树是没有区别的，所以同一种情况最多甚至有可能会算到6次。
- 怎么办？考虑burnside引理。
- 不同于项链问题，这次的置换有$3!$种（因为每一种排列都可行），我们要求出所有6种置换下的不动点。
- 如果$(1,2,3)\rightarrow(1,2,3)$，那么所有情况都是不动点。
- $(1,2,3)\rightarrow(2,1,3)/(1,3,2)/(3,2,1)$，那么要求有两个子树完全一样才能是不动点。
- $(1,2,3)\rightarrow(2,3,1)/(3,1,2)$，需要三个子树都完全一样才能是不动点。
- 所以$6*f_i=\sum_{x+y+z=i-1}f_x*f_y*f_z+3*\sum_{2*x+y=i-1}f_x*f_y+2*\sum_{3*x=i-1}f_x$。



### 烷烃计数

- 烷基计数和烷烃计数有个不同的地方：
- 烷基有根，但烷烃没有根。
- 这个不同直接导致了烷烃计数比烷基计数要难yi些，因为直接算的话，同一棵树就会被以不同的点为根重复计算多次。
- 首先，为了防止算重，我们先要让根是树中的一个独一无二的点，显然重心是最佳的选择（先不考虑有两个重心的情况）。
- 但是我们无法在计数的过程中保证根是重心，该怎么办呢？
- 这个时候，你就会发现你之前学过的那些组合数学好像统统不灵了——这也是正常的，因为这道题需要一个巧妙的思维转化。
- 知道有的时候怎么求树的方案数吗？总点数-总边数，因为点数总是比边数多1。这道题也是类似的。
- 但有一个问题——在一棵树中可能有两个等价的点，这样的话以它们为根的树就会长得完全一样，那么就只会被算一遍。
- 不过与此同时我们也会发现树中的边也有可能等价，那么会不会“因为等价点而漏算的个数等于由于等价边而漏算的个数呢”？如果是相等的，那么答案的正确性就不会受到影响。
- 一个极其重要的结论：一棵以重心为根的树中，如果两个点是等价的，那么它们的父亲边一定也是等价的。
- 证明：一个点的父亲边是指向重心的，意味着子树外的点数大于$\frac{n}{2}$，如果有另外的点和这个点的等价，那么这两个点的出边应该一一对应等价，两条等价的出边的同一侧（等价点的对侧）的点数应该是相同的，如果一个点的父亲边和另一个点的非父亲边等价，就意味着另一个等价点的子树大小大于$\frac{n}{2}$，这显然是不符合“重心为根”的约定。

- 这也就意味着，如果出现了一个等价点，也必然会出现一条等价边，答案就不会受到任何影响了！
- 等一下，还有一棵树有两个重心的情况？
- 发现答案会受到影响当且仅当两个重心为等价点，这个很好算。



### 简单的公式

- 首先是点，这个相当于烷基计数，只不过根可以有四个儿子。
- 接着是边，显然让边两端的子树的点数和为$n$即可。
- 也就是说$\frac{\sum_{i=1}^{n-1}f_i*f_{n-i}+[n\%2==0]*f_{n/2}}{2}$。
- 最后是一棵树有两颗重心并且它们是等价点。
- $n$为奇数时显然没有这种情况，$n$为偶数时即为$f_{n/2}$。
- 以上的$f$数组均为上文“烷基计数”中DP所用数组。
- 最后答案=点-边+重心。



### 烯烃计数

- 同样的，如果有$n$个碳，有多少种不同的一烯烃呢？
- 这个其实比“烷烃计数”要简单很多，因为一烯烃中有一条与众不同的边——碳碳双键，我们可以直接拿它来计数。
- 接下来和之前烷烃计数算“边”的方法差不多，只不过要注意一下碳碳双键两端的碳最多只能再多连接两个碳。



### 最后

- 以上的方法如果用生成函数求解均可以获得$O(n*logn)$的时间复杂度。











## LGV引理

- 我来填图论讲师一个小小的坑。



### 引入

- 问题描述是这样的：有两个起点$(0,1),(1,0)$​，以及两个终点$(m-1,n),(m,n-1)$，现在我们要求路径对$(P1,P2)$的数量，其中$P1$起点$(1,0)$，终点$(m,n-1)$，$P2$起点$(0,1)$，终点$(m-1,n)$​，并且两条路径不相交。
- 发现“无法相交”这个条件难以处理，考虑容斥：总方案数-相交方案数。
- 总方案数是很好求的，相交方案数该怎么求呢？
- 发现和之前求卡特兰数时所用的技巧是类似的，对于两条相交路径$(P1,P2)$，我们对调它们第一个相交点以后的路程，$P1$会因此变成从$(1,0)$到$(m-1,n)$的路径，而$P2$则变为从$(0,1)$到$(m,n-1)$的路径。
- 反过来，如果有一个路径对$(P'1,P'2),P'1:(1,0)\to(m-1,n),P'2:(0,1)\to(m,n-1)$，它们一定会相交，我们只需要交换它们第一个相遇点以后的路程则又可以变回来。
- 这是一个一一映射的关系，所以不合法的方案数=$(P'1,P'2)$的路径对数。
- 所以答案就是$(P1,P2)-(P'1,P'2)$。



### 扩展

- 仔细分析这个减法式子，先把它变得好看一点，设$a_{i,j}$表示的是从第$i$个起点到第$j$个终点的方案数，那么：

- $$
  Ans=a_{1,1}*a_{2,2}-a_{1,2}*a_{2,1}
  $$

- 发现答案形如上面这个式子。

- 这个是不是很像那个，就是那个，

- $$
  \begin{vmatrix}
  a_{1,1}~~a_{1,2}\\
  a_{2,1}~~a_{2,2}
  \end{vmatrix}
  $$

- 那么——它能否推广到起点终点更多的情况呢？



### LGV引理内容

- 答案是肯定的，对于$n$对起点与终点，我们设$a_{i,j}$为从第$i$个起点到第$j$个终点的方案数，那么如果要求从第$i$个起点到第$i$个终点的$n$条路径，并且这些路径两两不相交，那么答案就是：

- $$
  \begin{vmatrix}
  a_{1,1}&\cdots &a_{1,n}\\
  \vdots &\ddots &\vdots\\
  a_{n,1}&\cdots &a_{n,n}
  \end{vmatrix}
  $$

- 但值得注意的是，承载这些路径的图要有些特殊性质，具体可以参考一开始两对路径的证明过程——

- “$(P'1,P'2)$是一定相交的”。
